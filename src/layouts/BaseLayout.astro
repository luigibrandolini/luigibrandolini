---
import "../styles/global.css";

const {
  title,
  description,
  canonical,
  alternates,
  lang,
  siteName,
} = Astro.props;
const rawBaseUrl = import.meta.env.BASE_URL;
const baseUrl = rawBaseUrl.endsWith("/") ? rawBaseUrl : `${rawBaseUrl}/`;
const faviconIco = `${baseUrl}favicon.ico`;
const favicon16 = `${baseUrl}favicon-16x16.png`;
const favicon32 = `${baseUrl}favicon-32x32.png`;
const appleTouchIcon = `${baseUrl}apple-touch-icon.png`;
const webManifest = `${baseUrl}site.webmanifest`;
const socialImage = new URL(`${baseUrl}og-hero.jpg`, Astro.site).toString();
const googleSiteVerification = import.meta.env.PUBLIC_GOOGLE_SITE_VERIFICATION;
const bingSiteVerification = import.meta.env.PUBLIC_BING_SITE_VERIFICATION;
const yandexSiteVerification = import.meta.env.PUBLIC_YANDEX_SITE_VERIFICATION;
const xDefaultHref =
  alternates.find((item: { lang: string; href: string }) => item.lang === "it")?.href ?? canonical;
const localeMap: Record<string, string> = {
  it: "it_IT",
  en: "en_US",
  es: "es_ES",
  fr: "fr_FR",
};
const ogLocale = localeMap[lang] ?? "it_IT";
const alternateOgLocales = Object.entries(localeMap)
  .filter(([code]) => code !== lang)
  .map(([, og]) => og);
const personJsonLd = {
  "@context": "https://schema.org",
  "@type": "Person",
  name: siteName,
  url: canonical,
  image: socialImage,
  description,
  sameAs: [
    "https://github.com/luigibrandolini",
    "https://www.linkedin.com/in/luigibrandolini/",
    "https://www.facebook.com/ErmesSystems",
    "https://www.instagram.com/lb.creative.arts/",
    "https://www.youtube.com/@LuigiBrandolini",
  ],
};
const websiteJsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: siteName,
  url: Astro.site?.toString() ?? canonical,
  inLanguage: lang,
};
const cookieBannerContent: Record<string, {
  title: string;
  description: string;
  necessaryButton: string;
  acceptButton: string;
}> = {
  it: {
    title: "Preferenze cookie",
    description:
      "Questo sito utilizza cookie tecnici per memorizzare il consenso e, se accetti, la preferenza di lingua. Non vengono impostati cookie di profilazione o advertising.",
    necessaryButton: "Solo necessari",
    acceptButton: "Accetta",
  },
  en: {
    title: "Cookie preferences",
    description:
      "This site uses technical cookies to store consent and, if accepted, your language preference. We do not use profiling or advertising cookies.",
    necessaryButton: "Necessary only",
    acceptButton: "Accept",
  },
  es: {
    title: "Preferencias de cookies",
    description:
      "Este sitio usa cookies técnicas para guardar el consentimiento y, si aceptas, la preferencia de idioma. No usamos cookies de perfilado ni publicidad.",
    necessaryButton: "Solo necesarias",
    acceptButton: "Aceptar",
  },
  fr: {
    title: "Préférences des cookies",
    description:
      "Ce site utilise des cookies techniques pour mémoriser le consentement et, si vous l'acceptez, la langue choisie. Nous n'utilisons pas de cookies de profilage ni publicitaires.",
    necessaryButton: "Nécessaires seulement",
    acceptButton: "Accepter",
  },
};
const cookieCopy = cookieBannerContent[lang] ?? cookieBannerContent.it;
const supportedLocales = ["it", "en", "es", "fr"];
const defaultSiteLocale = "it";
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
    <meta name="generator" content={Astro.generator} />
    <meta name="googlebot" content="index,follow" />
    {googleSiteVerification && (
      <meta name="google-site-verification" content={googleSiteVerification} />
    )}
    {bingSiteVerification && (
      <meta name="msvalidate.01" content={bingSiteVerification} />
    )}
    {yandexSiteVerification && (
      <meta name="yandex-verification" content={yandexSiteVerification} />
    )}
    <title>{title}</title>
    <link rel="canonical" href={canonical} />
    {alternates.map((item: { lang: string; href: string }) => (
      <link rel="alternate" hreflang={item.lang} href={item.href} />
    ))}
    <link rel="alternate" hreflang="x-default" href={xDefaultHref} />
    <link rel="icon" type="image/x-icon" href={faviconIco} />
    <link rel="icon" type="image/png" sizes="32x32" href={favicon32} />
    <link rel="icon" type="image/png" sizes="16x16" href={favicon16} />
    <link rel="apple-touch-icon" href={appleTouchIcon} />
    <link rel="manifest" href={webManifest} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={socialImage} />
    <meta property="og:image:url" content={socialImage} />
    <meta property="og:image:secure_url" content={socialImage} />
    <meta property="og:image:type" content="image/jpeg" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={title} />
    <meta property="og:locale" content={ogLocale} />
    {alternateOgLocales.map((item) => (
      <meta property="og:locale:alternate" content={item} />
    ))}
    <meta property="og:site_name" content={siteName} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={socialImage} />
    <meta name="twitter:site" content="@luigibrandolini" />
    <meta name="twitter:creator" content="@luigibrandolini" />
    <meta name="keywords" content="Luigi Brandolini, software architect, technical project manager, agile delivery, scrum, project governance, digital transformation, workflow automation, IT strategy, microservices, cloud-native, domain-driven design, event-driven architecture, API design, scalability, resilience, observability, devops, containerization, AI strategy, generative AI, LLM integration, conversational interfaces, DSL engineering, AI governance, prompt engineering, intelligent automation, responsible AI" />
    <script type="application/ld+json" set:html={JSON.stringify(personJsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(websiteJsonLd)} />
  </head>
  <body>
    <div class="page">
      <slot />
    </div>
    <aside
      class="cookie-banner"
      id="cookie-banner"
      role="dialog"
      aria-live="polite"
      aria-labelledby="cookie-banner-title"
      data-supported-locales={JSON.stringify(supportedLocales)}
      data-default-locale={defaultSiteLocale}
      data-base-path={baseUrl}
    >
      <div class="cookie-banner-content">
        <p class="cookie-banner-title" id="cookie-banner-title">{cookieCopy.title}</p>
        <p class="cookie-banner-text">{cookieCopy.description}</p>
      </div>
      <div class="cookie-banner-actions">
        <button type="button" class="cookie-btn cookie-btn-secondary" id="cookie-accept-necessary">{cookieCopy.necessaryButton}</button>
        <button type="button" class="cookie-btn cookie-btn-primary" id="cookie-accept-all">{cookieCopy.acceptButton}</button>
      </div>
    </aside>
    <script is:inline>
      (() => {
        const CONSENT_COOKIE = "lb_cookie_consent";
        const LANGUAGE_COOKIE = "lb_preferred_lang";
        const CONSENT_MAX_AGE = 60 * 60 * 24 * 180;
        const SECURE_SUFFIX = window.location.protocol === "https:" ? "; Secure" : "";

        const readCookie = (name) => {
          const key = `${name}=`;
          const chunks = document.cookie ? document.cookie.split("; ") : [];
          for (const chunk of chunks) {
            if (chunk.startsWith(key)) {
              return decodeURIComponent(chunk.slice(key.length));
            }
          }
          return "";
        };

        const writeCookie = (name, value, maxAge) => {
          document.cookie = `${name}=${encodeURIComponent(value)}; path=/; max-age=${maxAge}; SameSite=Lax${SECURE_SUFFIX}`;
        };

        const banner = document.getElementById("cookie-banner");
        const acceptNecessaryButton = document.getElementById("cookie-accept-necessary");
        const acceptAllButton = document.getElementById("cookie-accept-all");
        const languageSelect = document.getElementById("lang-select");
        const supportedLocalesRaw = banner?.dataset.supportedLocales ?? '["it","en","es","fr"]';
        const SUPPORTED_LOCALES = (() => {
          try {
            const parsed = JSON.parse(supportedLocalesRaw);
            return Array.isArray(parsed) ? parsed : ["it", "en", "es", "fr"];
          } catch {
            return ["it", "en", "es", "fr"];
          }
        })();
        const DEFAULT_LOCALE = banner?.dataset.defaultLocale || "it";
        const BASE_PATH = banner?.dataset.basePath || "/";

        const hideBanner = () => {
          if (banner) {
            banner.classList.add("cookie-banner-hidden");
          }
        };

        const consentValue = readCookie(CONSENT_COOKIE);
        if (consentValue === "necessary" || consentValue === "all") {
          hideBanner();
        }

        if (consentValue === "all") {
          const preferredLanguageUrl = readCookie(LANGUAGE_COOKIE);
          if (preferredLanguageUrl) {
            try {
              const preferred = new URL(preferredLanguageUrl, window.location.origin);
              if (preferred.pathname !== window.location.pathname) {
                window.location.replace(preferred.href);
                return;
              }
            } catch {
              // Ignore malformed cookie values.
            }
          }
        }

        const normalizeBasePath = (path) => {
          if (!path || path === "/") {
            return "/";
          }
          return path.endsWith("/") ? path : `${path}/`;
        };

        const resolveBrowserLocale = () => {
          const browserLocales = Array.isArray(navigator.languages) && navigator.languages.length > 0
            ? navigator.languages
            : [navigator.language];
          for (const localeValue of browserLocales) {
            if (!localeValue) {
              continue;
            }
            const shortLocale = localeValue.toLowerCase().split("-")[0];
            if (SUPPORTED_LOCALES.includes(shortLocale)) {
              return shortLocale;
            }
          }
          return DEFAULT_LOCALE;
        };

        const basePath = normalizeBasePath(BASE_PATH);
        const currentPath = window.location.pathname;
        const pathWithoutBase = currentPath.startsWith(basePath)
          ? currentPath.slice(basePath.length)
          : currentPath.replace(/^\//, "");
        const firstSegment = pathWithoutBase.split("/")[0] || "";
        const isLocalizedPath = SUPPORTED_LOCALES.includes(firstSegment);
        const isDefaultHomepage = !isLocalizedPath && (pathWithoutBase === "" || pathWithoutBase === "index.html");

        if (isDefaultHomepage) {
          const browserLocale = resolveBrowserLocale();
          if (browserLocale !== DEFAULT_LOCALE) {
            const targetPath = `${basePath}${browserLocale}/`;
            window.location.replace(`${targetPath}${window.location.search}${window.location.hash}`);
            return;
          }
        }

        if (acceptNecessaryButton) {
          acceptNecessaryButton.addEventListener("click", () => {
            writeCookie(CONSENT_COOKIE, "necessary", CONSENT_MAX_AGE);
            hideBanner();
          });
        }

        if (acceptAllButton) {
          acceptAllButton.addEventListener("click", () => {
            writeCookie(CONSENT_COOKIE, "all", CONSENT_MAX_AGE);
            if (languageSelect instanceof HTMLSelectElement) {
              const currentValue = languageSelect.value || "";
              if (currentValue) {
                writeCookie(LANGUAGE_COOKIE, currentValue, CONSENT_MAX_AGE);
              }
            }
            hideBanner();
          });
        }

        if (languageSelect instanceof HTMLSelectElement) {
          languageSelect.addEventListener("change", () => {
            const nextUrl = languageSelect.value;
            if (nextUrl && readCookie(CONSENT_COOKIE) === "all") {
              writeCookie(LANGUAGE_COOKIE, nextUrl, CONSENT_MAX_AGE);
            }
            if (nextUrl) {
              window.location.href = nextUrl;
            }
          });
        }
      })();
    </script>
  </body>
</html>
